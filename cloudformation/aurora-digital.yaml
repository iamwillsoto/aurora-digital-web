AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Aurora Digital – Highly available web tier with ALB + AutoScaling in a
  /16 VPC with three public subnets. Instances are only reachable via ALB.
  Author: Will A. Soto (Cloud DevOps Engineer ☁️)

Parameters:
  EnvironmentName:
    Type: String
    Default: aurora-digital
    Description: Prefix for resource names
  InstanceType:
    Type: String
    Default: t2.micro
    AllowedValues: [t2.micro, t3.micro, t3.small]
    Description: EC2 instance type for web tier
  AmiIdParameter:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64
    Description: SSM parameter for the latest AL2023 AMI (x86_64)

Mappings:
  RegionMap:
    us-east-1:
      AMI: ami-0fc5d935ebf8bc3bc # fallback only; SSM parameter above is primary

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.10.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-vpc"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-igw"

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-public-rt"

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.10.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-public-a"

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.10.2.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-public-b"

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.10.3.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [2, !GetAZs '']
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-public-c"

  AssocPublicSubnet1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  AssocPublicSubnet2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  AssocPublicSubnet3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  LoadBalancerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP from the internet to ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-alb-sg"

  WebServerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP only from ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref LoadBalancerSG
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-web-sg"

  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${EnvironmentName}-alb"
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      SecurityGroups:
        - !Ref LoadBalancerSG
      Type: application
      IpAddressType: ipv4
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-alb"

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${EnvironmentName}-tg"
      Port: 80
      Protocol: HTTP
      VpcId: !Ref VPC
      TargetType: instance
      HealthCheckPath: /
      Matcher:
        HttpCode: '200-399'
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-tg"

  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub "${EnvironmentName}-lt"
      LaunchTemplateData:
        InstanceType: !Ref InstanceType
        ImageId: !Ref AmiIdParameter
        SecurityGroupIds:
          - !Ref WebServerSG
        MetadataOptions:
          HttpTokens: required
        UserData: !Base64 |
          #!/bin/bash
          set -euxo pipefail
          dnf -y update
          dnf -y install httpd
          cat > /var/www/html/index.html <<'EOF'
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title>Aurora Digital | Welcome</title>
            <style>
              body {font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; display:flex; min-height:100vh; align-items:center; justify-content:center; background:linear-gradient(135deg,#0f172a,#1e293b);} 
              .card{background:white; padding:28px 32px; border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.25); text-align:center;}
              h1{margin:0 0 10px; font-size:28px; letter-spacing:.2px;}
              p{margin:6px 0; color:#334155}
              .brand{font-weight:700}
              .pill{display:inline-block; margin-top:14px; padding:8px 12px; border-radius:999px; background:#e2e8f0; font-weight:600}
            </style>
          </head>
          <body>
            <div class="card">
              <h1><span class="brand">Aurora Digital</span> — Luxury Home Goods</h1>
              <p>Autoscaled, load-balanced, and secure on AWS.</p>
              <div class="pill">Will A. Soto — Cloud DevOps Engineer ☁️</div>
            </div>
          </body>
          </html>
          EOF
          systemctl enable --now httpd
          echo 'ServerSignature Off' >> /etc/httpd/conf/httpd.conf
          echo 'ServerTokens Prod' >> /etc/httpd/conf/httpd.conf
          systemctl restart httpd

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      MinSize: '2'
      MaxSize: '5'
      DesiredCapacity: '2'
      HealthCheckType: ELB
      HealthCheckGracePeriod: 90
      TargetGroupARNs:
        - !Ref TargetGroup
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentName}-web"
          PropagateAtLaunch: true

Outputs:
  LoadBalancerDNS:
    Description: DNS name of the public Application Load Balancer
    Value: !GetAtt ALB.DNSName
    Export:
      Name: !Sub "${EnvironmentName}-alb-dns"
